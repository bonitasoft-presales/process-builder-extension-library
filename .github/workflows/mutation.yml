# ============================================================================
# Mutation Testing Workflow
# ============================================================================
# This workflow runs PIT Mutation Testing on demand.
# It is NOT run automatically - only when manually triggered from GitHub UI.
#
# Usage:
#   1. Go to Actions tab in GitHub
#   2. Select "Mutation Testing" workflow
#   3. Click "Run workflow"
#   4. View results in the workflow summary or download artifacts
#
# Note: This takes ~8-10 minutes to complete
# ============================================================================

name: Mutation Testing

on:
  workflow_dispatch:
    inputs:
      mutator:
        description: 'Mutator strength'
        required: true
        default: 'DEFAULTS'
        type: choice
        options:
          - DEFAULTS
          - STRONGER

permissions:
  contents: read

jobs:
  mutation:
    name: PIT Mutation Testing
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make Maven Wrapper executable
        run: chmod +x mvnw

      - name: Install Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Mutation Testing
        run: |
          echo "Running PIT Mutation Testing with ${{ github.event.inputs.mutator }} mutators..."
          ./mvnw clean test pitest:mutationCoverage \
            -Dpitest.mutators=${{ github.event.inputs.mutator }}

      - name: Upload Mutation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pit-mutation-report
          path: target/pit-reports/
          retention-days: 30

      - name: Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ§¬ Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Mutator strength: \`${{ github.event.inputs.mutator }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f target/pit-reports/mutations.csv ]; then
            echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count mutations
            TOTAL=$(tail -n +2 target/pit-reports/mutations.csv | wc -l)
            KILLED=$(grep -c ",KILLED," target/pit-reports/mutations.csv || echo 0)
            SURVIVED=$(grep -c ",SURVIVED," target/pit-reports/mutations.csv || echo 0)
            NO_COVERAGE=$(grep -c ",NO_COVERAGE," target/pit-reports/mutations.csv || echo 0)

            # Calculate mutation score
            if [ "$TOTAL" -gt 0 ]; then
              SCORE=$(echo "scale=1; $KILLED * 100 / $TOTAL" | bc)
            else
              SCORE="N/A"
            fi

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Mutation Score** | **${SCORE}%** |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Mutants | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Killed (detected) | $KILLED âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Survived (not detected) | $SURVIVED âš ï¸ |" >> $GITHUB_STEP_SUMMARY
            echo "| No Coverage | $NO_COVERAGE âŒ |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show top surviving mutations by class
            if [ "$SURVIVED" -gt 0 ]; then
              echo "### âš ï¸ Classes with Surviving Mutants" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "These classes have mutations that were not detected by tests:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Class | Survivors |" >> $GITHUB_STEP_SUMMARY
              echo "|-------|-----------|" >> $GITHUB_STEP_SUMMARY
              grep ",SURVIVED," target/pit-reports/mutations.csv | cut -d',' -f1 | sort | uniq -c | sort -rn | head -10 | while read count class; do
                echo "| \`$class\` | $count |" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ðŸ“¥ Download Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the **pit-mutation-report** artifact from the Artifacts section below to view the full HTML report." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The report includes:" >> $GITHUB_STEP_SUMMARY
          echo "- Detailed mutation analysis per class" >> $GITHUB_STEP_SUMMARY
          echo "- Line-by-line mutation results" >> $GITHUB_STEP_SUMMARY
          echo "- Source code with mutation markers" >> $GITHUB_STEP_SUMMARY
